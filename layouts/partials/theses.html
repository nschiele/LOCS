{{ define "theses" }}
<style>
  .theses-container {
    max-width: 100%;
  }
  .thesis-section {
    margin-bottom: 2rem;
  }
  .thesis-section h2 {
    border-bottom: 1px solid var(--color-border-muted);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }
  .status-filter {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    margin-right: 8px;
    margin-bottom: 16px;
    font-size: 14px;
    text-decoration: none;
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    background-color: var(--color-canvas-default);
    color: var(--color-fg-default);
  }
  .status-filter.active {
    --background-color: var(--color-primer-canvas-backdrop);
    border-color: var(--color-accent-emphasis);
  }
  .thesis-item {
    display: flex;
    padding: 16px;
    border: 1px solid var(--color-border-muted);
    border-radius: 6px;
    margin-bottom: 16px;
    background-color: var(--color-canvas-default);
  }
  .thesis-status {
    margin-right: 12px;
    flex-shrink: 0;
    padding-top: 2px;
  }
  .thesis-open {
    color: #1a7f37;
  }
  .thesis-closed {
    color: #8250df;
  }
  .thesis-content {
    flex: 1;
    min-width: 0;
  }
  .thesis-title {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
  }
  .thesis-title a {
    color: var(--color-accent-fg);
    text-decoration: none;
  }
  .thesis-title a:hover {
    text-decoration: underline;
  }
  .thesis-meta {
    font-size: 12px;
    color: var(--color-fg-muted);
    margin-bottom: 8px;
  }
  .thesis-meta a {
    color: var(--color-accent-fg);
    text-decoration: none;
  }
  .thesis-meta a:hover {
    text-decoration: underline;
  }
  .thesis-tags {
    margin-bottom: 8px;
  }
  .thesis-tag {
    display: inline-block;
    padding: 2px 8px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 12px;
    margin-right: 4px;
    margin-bottom: 4px;
    text-decoration: none;
  }
  .tag-master {
    background-color: #dafbe1;
    color: #1a7f37;
  }
  .tag-bachelor {
    background-color: #fff8c5;
    color: #9a6700;
  }
  .tag-default {
    background-color: #ddf4ff;
    color: #0969da;
  }
  .thesis-summary {
    color: var(--color-fg-default);
    line-height: 1.5;
  }
  .section-stats {
    font-size: 14px;
    color: var(--color-fg-muted);
    margin-bottom: 1rem;
  }
</style>

<div class="theses-container">
  <div class="position-relative">
    <h1 class="mb-3">Theses</h1>
    
    <!-- Status Filter Buttons -->
    <div class="mb-4">
      <a href="?status=all" class="status-filter" id="filter-all">
        All Theses
      </a>
      <a href="?status=open" class="status-filter" id="filter-open">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="mr-1">
          <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
          <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path>
        </svg>
        Open
      </a>
      <a href="?status=closed" class="status-filter" id="filter-closed">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="mr-1">
          <path d="M11.28 6.78a.75.75 0 0 0-1.06-1.06L7.25 8.69 5.78 7.22a.75.75 0 0 0-1.06 1.06l2 2a.75.75 0 0 0 1.06 0l3.5-3.5Z"></path>
          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0Zm-1.5 0a6.5 6.5 0 1 0-13 0 6.5 6.5 0 0 0 13 0Z"></path>
        </svg>
        Closed
      </a>
    </div>

    {{ $allTheses := .Pages }}
    {{ $masterTheses := where $allTheses ".Params.tags" "intersect" (slice "Master thesis") }}
    {{ $bachelorTheses := where $allTheses ".Params.tags" "intersect" (slice "Bachelor thesis") }}
    
    <!-- Master Theses Section -->
    {{ if $masterTheses }}
    <div class="thesis-section" id="master-section">
      <h2>Master Theses</h2>
      <div class="section-stats">
        {{ $openMaster := where $masterTheses ".Params.completed" "ne" true }}
        {{ $closedMaster := where $masterTheses ".Params.completed" "eq" true }}
        {{ len $openMaster }} open, {{ len $closedMaster }} closed
      </div>
      
      {{ range $masterTheses }}
      <div class="thesis-item" data-status="{{ if .Params.completed }}closed{{ else }}open{{ end }}">
        <div class="thesis-status">
          {{ if .Params.completed }}
          <svg class="thesis-closed" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M11.28 6.78a.75.75 0 0 0-1.06-1.06L7.25 8.69 5.78 7.22a.75.75 0 0 0-1.06 1.06l2 2a.75.75 0 0 0 1.06 0l3.5-3.5Z"></path>
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0Zm-1.5 0a6.5 6.5 0 1 0-13 0 6.5 6.5 0 0 0 13 0Z"></path>
          </svg>
          {{ else }}
          <svg class="thesis-open" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path>
          </svg>
          {{ end }}
        </div>
        
        <div class="thesis-content">
          <div class="thesis-title">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </div>
          
          <div class="thesis-meta">
            {{ if .Params.completed }}Completed{{ else }}Available{{ end }}
            
            {{ if .Params.supervisors }}
            • Supervised by:
            {{ $haveSlugs := .Params.supervisors_slugs }}
            {{ range $index, $supervisor := .Params.supervisors }}
              {{- if gt $index 0 }}, {{ end -}}
              {{ $linked := false }}
              {{/* Prefer explicit slug when provided */}}
              {{ if and $haveSlugs (index $haveSlugs $index) }}
                {{ $slug := index $haveSlugs $index }}
                {{ with site.GetPage (printf "/team/%s/" $slug) }}
                  <a href="{{ .RelPermalink }}">{{ $supervisor }}</a>
                  {{ $linked = true }}
                {{ end }}
              {{ end }}
              {{/* Fallback: resolve by full name match against team params */}}
              {{ if not $linked }}
                {{ $superLower := lower $supervisor }}
                {{ $match := false }}
                {{ range where $.Site.RegularPages "Section" "team" }}
                  {{ $full := lower (printf "%s %s" .Params.firstname .Params.lastname) }}
                  {{ if eq $full $superLower }}
                    <a href="{{ .RelPermalink }}">{{ $supervisor }}</a>
                    {{ $match = true }}
                  {{ end }}
                {{ end }}
                {{ if not $match }}{{ $supervisor }}{{ end }}
              {{ end }}
            {{ end }}
            {{ end }}
            
            {{ if .Date }}
            • {{ .Date.Format "January 2, 2006" }}
            {{ end }}
            
            {{ if or .Params.students .Params.student }}
            • Student:
            {{ $students := slice }}
            {{ if .Params.students }}
              {{ $students = .Params.students }}
            {{ else }}
              {{ $students = split (or .Params.student "") "," }}
            {{ end }}
            {{ $studentSlugs := .Params.student_slugs }}
            {{ range $i, $raw := $students }}
              {{- if gt $i 0 }}, {{ end -}}
              {{ $name := trim $raw " \t\n\r" }}
              {{ $linked := false }}
              {{/* Prefer indexed slug if provided */}}
              {{ if and $studentSlugs (index $studentSlugs $i) }}
                {{ $slug := index $studentSlugs $i }}
                {{ with site.GetPage (printf "/team/%s/" $slug) }}
                  <a href="{{ .RelPermalink }}">{{ .Params.firstname }} {{ .Params.lastname }}</a>
                  {{ $linked = true }}
                {{ end }}
              {{ else if and (not $studentSlugs) $.Params.student_slug (eq (len $students) 1) }}
                {{ with site.GetPage (printf "/team/%s/" $.Params.student_slug) }}
                  <a href="{{ .RelPermalink }}">{{ .Params.firstname }} {{ .Params.lastname }}</a>
                  {{ $linked = true }}
                {{ end }}
              {{ end }}
              {{ if not $linked }}
                {{ $token := lower $name }}
                {{ $matched := false }}
                {{/* Try match by init code (e.g., ms-yy) */}}
                {{ range where $.Site.RegularPages "Section" "team" }}
                  {{ if and .Params.init (eq (lower .Params.init) $token) }}
                    <a href="{{ .RelPermalink }}">{{ .Params.firstname }} {{ .Params.lastname }}</a>
                    {{ $matched = true }}
                  {{ end }}
                {{ end }}
                {{ if not $matched }}
                  {{/* Try match by full name */}}
                  {{ range where $.Site.RegularPages "Section" "team" }}
                    {{ $full := lower (printf "%s %s" .Params.firstname .Params.lastname) }}
                    {{ if eq $full $token }}
                      <a href="{{ .RelPermalink }}">{{ $name }}</a>
                      {{ $matched = true }}
                    {{ end }}
                  {{ end }}
                {{ end }}
                {{ if not $matched }}{{ $name }}{{ end }}
              {{ end }}
            {{ end }}
            {{ end }}
          </div>
          
          {{ if .Params.tags }}
          <div class="thesis-tags">
            {{ range .Params.tags }}
            {{ $tagClass := "tag-default" }}
            {{ if eq . "Master thesis" }}
              {{ $tagClass = "tag-master" }}
            {{ else if eq . "Bachelor thesis" }}
              {{ $tagClass = "tag-bachelor" }}
            {{ end }}
            <a href="{{ relURL (print "/tags/" . | urlize) }}" class="thesis-tag {{ $tagClass }}">{{ . }}</a>
            {{ end }}
          </div>
          {{ end }}
          
          {{ if .Summary }}
          <div class="thesis-summary">
            {{ .Summary | truncate 200 }}
          </div>
          {{ end }}
        </div>
      </div>
      {{ end }}
    </div>
    {{ end }}
    
    <!-- Bachelor Theses Section -->
    {{ if $bachelorTheses }}
    <div class="thesis-section" id="bachelor-section">
      <h2>Bachelor Theses</h2>
      <div class="section-stats">
        {{ $openBachelor := where $bachelorTheses ".Params.completed" "ne" true }}
        {{ $closedBachelor := where $bachelorTheses ".Params.completed" "eq" true }}
        {{ len $openBachelor }} open, {{ len $closedBachelor }} closed
      </div>
      
      {{ range $bachelorTheses }}
      <div class="thesis-item" data-status="{{ if .Params.completed }}closed{{ else }}open{{ end }}">
        <div class="thesis-status">
          {{ if .Params.completed }}
          <svg class="thesis-closed" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M11.28 6.78a.75.75 0 0 0-1.06-1.06L7.25 8.69 5.78 7.22a.75.75 0 0 0-1.06 1.06l2 2a.75.75 0 0 0 1.06 0l3.5-3.5Z"></path>
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0Zm-1.5 0a6.5 6.5 0 1 0-13 0 6.5 6.5 0 0 0 13 0Z"></path>
          </svg>
          {{ else }}
          <svg class="thesis-open" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path>
          </svg>
          {{ end }}
        </div>
        
        <div class="thesis-content">
          <div class="thesis-title">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </div>
          
          <div class="thesis-meta">
            {{ if .Params.completed }}Completed{{ else }}Available{{ end }}
            
            {{ if .Params.supervisors }}
            • Supervised by:
            {{ range $index, $supervisor := .Params.supervisors }}
              {{- if gt $index 0 }}, {{ end -}}
              {{ $superLower := lower $supervisor }}
              {{ $match := false }}
              {{ range where $.Site.RegularPages "Section" "team" }}
                {{ $full := lower (printf "%s %s" .Params.firstname .Params.lastname) }}
                {{ if eq $full $superLower }}
                  <a href="{{ .RelPermalink }}">{{ $supervisor }}</a>
                  {{ $match = true }}
                {{ end }}
              {{ end }}
              {{ if not $match }}{{ $supervisor }}{{ end }}
            {{ end }}
            {{ end }}
            
            {{ if .Date }}
            • {{ .Date.Format "January 2, 2006" }}
            {{ end }}
            
            {{ if or .Params.students .Params.student }}
            • Student:
            {{ $students := slice }}
            {{ if .Params.students }}
              {{ $students = .Params.students }}
            {{ else }}
              {{ $students = split (or .Params.student "") "," }}
            {{ end }}
            {{ $studentSlugs := .Params.student_slugs }}
            {{ range $i, $raw := $students }}
              {{- if gt $i 0 }}, {{ end -}}
              {{ $name := trim $raw " \t\n\r" }}
              {{ $linked := false }}
              {{ if and $studentSlugs (index $studentSlugs $i) }}
                {{ $slug := index $studentSlugs $i }}
                {{ with site.GetPage (printf "/team/%s/" $slug) }}
                  <a href="{{ .RelPermalink }}">{{ .Params.firstname }} {{ .Params.lastname }}</a>
                  {{ $linked = true }}
                {{ end }}
              {{ else if and (not $studentSlugs) $.Params.student_slug (eq (len $students) 1) }}
                {{ with site.GetPage (printf "/team/%s/" $.Params.student_slug) }}
                  <a href="{{ .RelPermalink }}">{{ .Params.firstname }} {{ .Params.lastname }}</a>
                  {{ $linked = true }}
                {{ end }}
              {{ end }}
              {{ if not $linked }}
                {{ $token := lower $name }}
                {{ $matched := false }}
                {{ range where $.Site.RegularPages "Section" "team" }}
                  {{ if and .Params.init (eq (lower .Params.init) $token) }}
                    <a href="{{ .RelPermalink }}">{{ .Params.firstname }} {{ .Params.lastname }}</a>
                    {{ $matched = true }}
                  {{ end }}
                {{ end }}
                {{ if not $matched }}
                  {{ range where $.Site.RegularPages "Section" "team" }}
                    {{ $full := lower (printf "%s %s" .Params.firstname .Params.lastname) }}
                    {{ if eq $full $token }}
                      <a href="{{ .RelPermalink }}">{{ $name }}</a>
                      {{ $matched = true }}
                    {{ end }}
                  {{ end }}
                {{ end }}
                {{ if not $matched }}{{ $name }}{{ end }}
              {{ end }}
            {{ end }}
            {{ end }}
          </div>
          
          {{ if .Params.tags }}
          <div class="thesis-tags">
            {{ range .Params.tags }}
            {{ $tagClass := "tag-default" }}
            {{ if eq . "Master thesis" }}
              {{ $tagClass = "tag-master" }}
            {{ else if eq . "Bachelor thesis" }}
              {{ $tagClass = "tag-bachelor" }}
            {{ end }}
            <a href="{{ relURL (print "/tags/" . | urlize) }}" class="thesis-tag {{ $tagClass }}">{{ . }}</a>
            {{ end }}
          </div>
          {{ end }}
          
          {{ if .Summary }}
          <div class="thesis-summary">
            {{ .Summary | truncate 200 }}
          </div>
          {{ end }}
        </div>
      </div>
      {{ end }}
    </div>
    {{ end }}
    
    <!-- Show message if no theses found -->
    {{ if not (or $masterTheses $bachelorTheses) }}
    <div class="thesis-item">
      <div class="thesis-content">
        <div class="thesis-title">No theses found</div>
        <div class="thesis-meta">There are currently no theses available.</div>
      </div>
    </div>
    {{ end }}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get current status from URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const currentStatus = urlParams.get('status') || 'all';
  
  // Update active filter button
  document.querySelectorAll('.status-filter').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById('filter-' + currentStatus).classList.add('active');
  
  // Filter thesis items
  const thesisItems = document.querySelectorAll('.thesis-item');
  
  thesisItems.forEach(item => {
    const itemStatus = item.getAttribute('data-status');
    
    if (currentStatus === 'all' || currentStatus === itemStatus) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
  
  // Update section visibility
  const masterSection = document.getElementById('master-section');
  const bachelorSection = document.getElementById('bachelor-section');
  
  if (masterSection) {
    const visibleMasterItems = masterSection.querySelectorAll('.thesis-item[style*="flex"], .thesis-item:not([style])');
    const hasVisibleMaster = Array.from(visibleMasterItems).some(item => 
      item.style.display !== 'none' && (currentStatus === 'all' || item.getAttribute('data-status') === currentStatus)
    );
    masterSection.style.display = hasVisibleMaster ? 'block' : 'none';
  }
  
  if (bachelorSection) {
    const visibleBachelorItems = bachelorSection.querySelectorAll('.thesis-item[style*="flex"], .thesis-item:not([style])');
    const hasVisibleBachelor = Array.from(visibleBachelorItems).some(item => 
      item.style.display !== 'none' && (currentStatus === 'all' || item.getAttribute('data-status') === currentStatus)
    );
    bachelorSection.style.display = hasVisibleBachelor ? 'block' : 'none';
  }
});
</script>
{{ end }}
